<!DOCTYPE html>
<html>
<head>
   <title>OL</title>
   <meta charset="utf-8" />

   <link rel='stylesheet' href='stylesheets/normalize.css'>
   <script src='javascripts/jquery-2.1.1.min.js'> </script>
   <script src='javascripts/jquery.livequery.js'> </script>

   <link rel='stylesheet' href='stylesheets/form.css'>
   <script src='javascripts/stars!-1.0.0.js'></script>
<script src="javascripts/olvm-1.0-loader.js"></script>
</head><body><!-- ===================================== -->

<!-- "loading..." and <noscript> part -->
   <section id='main'
            class='loginform cf'>
      <form id='loading'>
         <ul><label id='loading-text'>
            Please wait, while loading the rendering engine ...
         </label></ul>
      </form>
      <script> // show points after "loading" text
         (function ticker(){
            var loading = $('#loading-text');
            if (loading.length) {
               loading.append('. ');
               setTimeout(ticker, 1000);
            }
         })();
      </script>
   </section>

<!-- ol part -->

<!-- using text/x-frozen-html for content:
   http://stackoverflow.com/questions/4397577/how-do-i-get-the-original-innerhtml-source-without-the-javascript-generated-cont -->
<!-- that's all - next code is lisp code -->
<script id="lisp" type="text/x-frozen-html" language="ol">

(define (! . something)
   (let ((x (fold string-append "" something)))
      (print x)
      (syscall 1201 3 (c-string x) #false)))

(define (html . args)
   (let html ((args args))
      (for-each (lambda (arg)
         (if arg ; not #false
            (if (list? arg)
               (html arg)
               (if (not (null? arg))
                  (display arg)))))
         args)))

; tag split into parts due to http://stackoverflow.com/questions/236073/why-split-the-script-tag-when-writing-it-with-document-write/236106#236106
(define-syntax script
(syntax-rules ()
   ((script rest...)
      (! rest...))))

(define-syntax tag
(syntax-rules ()
   ((tag . rest)
      (list ">" . rest))))




(define-syntax section
(syntax-rules (- id class)
   ((section - (class value) . rest)
      (list
         " class=\""value"\""
         (section - . rest)))
   ((section - (id value) . rest)
      (list
         " id=\""value"\""
         (section - . rest)))

   ((section - . rest)
      (list ">" . rest))
   ((section . rest)
      (list
         "<section"
            (section - . rest)
         "</section>"))))


(define-syntax form
(syntax-rules (- id action method accept-charset onsubmit name)
   ((form - (id value...) . rest)
      (list
         " id=\""value..."\""
         (form - . rest)))
   ((form - (action value...) . rest)
      (list
         " action=\""value..."\""
         (form - . rest)))
   ((form - (name value...) . rest)
      (list
         " name=\""value..."\""
         (form - . rest)))
   ((form - (onsubmit value...) . rest)
      (list
         " onsubmit=\""value..."\""
         (form - . rest)))

   ((form - . rest)
      (list ">" . rest))
   ((form . rest)
      (list
         "<form"
         " method='get'"
         " accept-charset='utf-8'"
            (form - . rest)
         "</form>"))))

(define-syntax a
(syntax-rules (- id href style onclick)
   ((a - (id value...) . rest)
      (list
         " id=\""value..."\""
         (a - . rest)))
   ((a - (href value...) . rest)
      (list
         " href=\""value..."\""
         (a - . rest)))
   ((a - (style value...) . rest)
      (list
         " style=\""value..."\""
         (a - . rest)))
   ((a - (onclick value...) . rest)
      (list
         " onclick=\""value..."\""
         (a - . rest)))

   ((a - . rest)
      (list ">" . rest))
   ((a . rest)
      (list
         "<a"
            (a - . rest)
         "</a>"))))

(define-syntax ul
(syntax-rules ()
   ((ul rest...)
      (list
         "<ul>"
           rest...
         "</ul>"))))

(define-syntax br
(syntax-rules ()
   ((br)
      "<br>")))
(define-syntax hr
(syntax-rules ()
   ((hr)
      "<hr>")))

(define-syntax li
(syntax-rules (- style)
   ((li - (style value) rest...)
      (list
         " style=\""value"\""
         (li - rest...)))

   ((li - rest...)
      (list ">" rest...))
   ((li rest...)
      (list
         "<li"
           (li - rest...)
         "</li>"))))
(define-syntax li-
   (syntax-rules ()
      ((li- rest...)
         (list
            "<li style='clear:both'>"
              rest...
            "</li>"))))



(define-syntax label
(syntax-rules ()
   ((label rest...)
      (list
         "<label>"
            rest...
         "</label>"))))

(define-syntax input
(syntax-rules (- id type name placeholder required readonly value)
   ((input - (id arg) rest...)
      (list
         " id=\""arg"\""
         (input - rest...)))
   ((input - (type arg) rest...)
      (list
         " type=\""arg"\""
         (input - rest...)))
   ((input - (name arg) rest...)
      (list
         " name=\""arg"\""
         (input - rest...)))
   ((input - (placeholder arg) rest...)
      (list
         " placeholder=\""arg"\""
         (input - rest...)))
   ((input - (required) rest...)
      (list
         " required"
         (input - rest...)))
;   ((input - (readonly is) rest...)
;      (list
;         (if is " readonly")
;         (input - rest...)))
   ((input - (readonly) rest...)
      (list
         " readonly"
         (input - rest...)))
   ((input - (value arg) rest...)
      (list
         " value=\""arg"\""
         (input - rest...)))

   ((input - rest...)
      (list ">" rest...))
   ((input rest...)
      (list
         "<input"
           (input - rest...)))))

(define-syntax table
(syntax-rules ()
   ((table rest...)
      (list
         "<table>"
           rest...
         "</table>"))))
(define-syntax tr
(syntax-rules ()
   ((tr rest...)
      (list
         "<tr>"
           rest...
         "</tr>"))))
(define-syntax th
(syntax-rules ()
   ((th rest...)
      (list
         "<th>"
           rest...
         "</th>"))))
(define-syntax td
(syntax-rules (- colspan style)
   ((td - (style value) rest...)
      (list
         " style="value
         (td - rest...)))
   ((td - (colspan value) rest...)
      (list
         " colspan="value
         (td - rest...)))

   ((td - rest...)
      (list ">" rest...))
   ((td rest...)
      (list
         "<td"
           (td - rest...)
         "</td>"))))


(define (map* f a)
   (let loop ((a a))
      (if (null? a)
         '()
         (cons (apply f (car a)) (loop (cdr a))))))

; actions:

; =-( code entry )=----------------------------------------

; устанавливает session ключ
(define (assign-the-session sid)
   (fork-server 'sess (lambda ()
   (let this ((the-session sid))
   (let* ((envelope (wait-mail))
          (sender msg envelope))
      (mail sender the-session))
      (this the-session)))));;;; simplest that simple
(define (get-the-session)
   (interact 'sess #false))

; -=( login )=---------------------------------------------
; 
(define (show-login-section)
   (! "$('#main').remove()")
   (html
      (section (id "main")
               (class "loginform cf")
         ; http://www.scriptol.com/html5/forms.php
         (form (id "login")
               (action "/login")
            (ul
               (li (label "Email")
                   (input (id "usermail") (type "usermail")
                          (placeholder "yourname@mail.com")
                          (required)))
               (li (label "Password")
                   (input (id "password") (type "password")
                          (placeholder "strong passphrase")
                          (required)))
               (li-
                   (input (type "submit") (value "Login")))))
         ))
   (! "$('#login').submit(function(event) {
         goto([login.action,
               login.elements.usermail.value,
               login.elements.password.value]
               , 'login-ok', 'login-failed');
         event.preventDefault();
      });")
   (print))

(define (login-failed error)
   (! "$('#main').remove()")
   (html
      (section (id "main")
               (class "loginform cf")
         ; http://www.scriptol.com/html5/forms.php
         (form (id "sorry")
               (action "/")
            (ul
               (li (label "Sorry, name or password is invalid."))
               (li-
                   (input (type "submit") (value "Please, try again.")))))))
   (! "$('#sorry').submit(function(event) {
         OL('(show-login-section)');
         event.preventDefault();
      });")
   (print))


; если логин прошел нормально, покажем домашний скрин
(define (login-ok session)
   (! "console.log('login-ok/ session: "session"')")

   (assign-the-session session)
   (! "goto(['/home', '"session"']
             ,'home', '-fail-');")
   (print))

; ---------------------------------------------------------
; -=( forms )=---------------------------------------------
;

(define (action text args ok fail)
   (let ((url (car args))
         (args (cdr args)))
      (list
          "<a href='#' onclick=\"goto(['/home', '"123456789"'],'"ok"', '"fail"');\">"
          text
          "</a>"
          )))

            ;
            ;(fold (lambda (n x) (fold string-append "" (list n ", " "'"x"'")))
            ;   (fold string-append "" (list "'" url "'")) (list args)
            ;)
            ;"], '"ok"', '"fail"'); return false;\">"
          ;

(define (home username data)
   (! "console.log('home/ username: " username "')")

   (define session (get-the-session))
   ;(! "$('#main').remove()")
   (! "document.body.innerHTML = ''")
   (html
      "Hello " username
;      (section (id "main")
;               (class "loginform cf")
;         "Hello " username

   ; в эту табличку мы поместим все расы игрока и играемые ними игры:
         (table
               (tr (th "Race") (th "Game"))
               (map* (lambda (rid name games)
                  (tr
                     (td
                        (a (href "/race/"session"/"rid) name))
                     (td
                        (table
                           (map* (lambda (gid name state)
                                       (tr
                                          (td gid) (td name)
                                          (td (a (href "/game/"session"/"gid)
                                                (if (eq? state 0)
                                                   "(edit)"
                                                   "(view)")))
                                          (td
                                             (case state ; todo: make new query to check the current race state, not common
                                                (0 "New one")
                                                (1 "Waiting for players")
                                                (2 "Wait for turns")
                                                (3 "Thinking...")
                                                (4 "Closed")
                                                (else "Unknown")))))
                              games)
                           (tr
                              (td (colspan 4) (style "text-align:center")
                                 (a (href "/create-new-game/"session"/"rid) "(create new game)")))))))
                  data)
               (tr (td (colspan 2) (style "text-align:center")
                      (a (href "javascript:;")
                         (onclick "goto(['/create-new-race/"session"'], 'create-new-race-ok', 'say-fail')")
                         "do something")
                  ))))
   (print))

                  ;(action "(create new race)"
                  ;   ("/create-new-race" session) "say-ok" "say-fail")

(define (create-new-race-ok id)
   (! "console.log('create-new-race-ok/ id: " id "')")
   (! "goto(['/home', '" (get-the-session) "']
             ,'home', '-fail-');")
   (print))

(define (say-ok . ok)
   (print ok))
(define (say-fail . fail)
   (print fail))

; let's game begin
(show-login-section) ; temp skip the login screen
;(login-ok "7678b7c0dd811a047b8a743cf986e418")

(print) ;flush (на всякий случай)
</script></body></html>