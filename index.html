<!DOCTYPE html>
<html>
<head>
   <title>OL</title>

   <link rel='stylesheet' href='stylesheets/normalize.css'>
   <script src='javascripts/jquery-2.1.1.min.js'> </script>
   <script src='javascripts/jquery.livequery.js'> </script>

   <link rel='stylesheet' href='stylesheets/form.css'>
   <script src='javascripts/stars!-1.0.0.js'></script>
</head><body><!-- ===================================== -->
<!-- loading and noscript part -->
   <div id='loading'>
   <section class='loginform cf'>
      <form id='login'>
         <ul><label id='loading-text'>
            Please wait, while loading the rendering engine
         </label></ul>
      </form>
      <script> // show points after "loading" text
         (function ticker(){
            var loading = $('#loading-text');
            if (loading.length) {
               loading.append('.');
               setTimeout(ticker, 1000);
            }
         })();
      </script>
   </section>
   </div>

<!-- ol part -->
<script>
// please, start virtual machine only at runtime!
$(function() {
   var script = document.createElement('script');
   script.src = "javascripts/olvm-1.0-loader.js";
   document.body.appendChild(script);
});
</script>

<!-- using text/x-frozen-html for content: http://stackoverflow.com/questions/4397577/how-do-i-get-the-original-innerhtml-source-without-the-javascript-generated-cont -->
<!-- that's all - next code is lisp code -->
<script id="lisp" type="text/x-frozen-html">

(define (html . args)
   (let html ((args args))
      (for-each (lambda (arg)
         (if arg ; not #false
            (if (list? arg)
               (html arg)
               (if (not (null? arg))
                  (display arg)))))
         args)))

; tag split into parts due to http://stackoverflow.com/questions/236073/why-split-the-script-tag-when-writing-it-with-document-write/236106#236106
(define-syntax script
(syntax-rules ()
   ((script rest...)
      (list
         "<" "script>"
           rest...
         "</" "script" ">"))))

(define-syntax tag
(syntax-rules ()
   ((tag . rest)
      (list ">" . rest))))




(define-syntax section
(syntax-rules (- id class)
   ((section - (class value) . rest)
      (list
         " class=\""value"\""
         (section - . rest)))
   ((section - (id value) . rest)
      (list
         " id=\""value"\""
         (section - . rest)))

   ((section - . rest)
      (list ">" . rest))
   ((section . rest)
      (list
         "<section"
            (section - . rest)
         "</section>"))))


(define-syntax form
(syntax-rules (- id action method accept-charset onsubmit name)
   ((form - (id value...) . rest)
      (list
         " id=\""value..."\""
         (form - . rest)))
   ((form - (action value...) . rest)
      (list
         " action=\""value..."\""
         (form - . rest)))
   ((form - (name value...) . rest)
      (list
         " name=\""value..."\""
         (form - . rest)))
   ((form - (onsubmit value...) . rest)
      (list
         " onsubmit=\""value..."\""
         (form - . rest)))

   ((form - . rest)
      (list ">" . rest))
   ((form . rest)
      (list
         "<form"
         " method='get'"
         " accept-charset='utf-8'"
            (form - . rest)
         "</form>"))))

(define-syntax a
(syntax-rules (- id href style)
   ((a - (id value...) . rest)
      (list
         " id=\""value..."\""
         (a - . rest)))
   ((a - (href value...) . rest)
      (list
         " href=\""value..."\""
         (a - . rest)))
   ((a - (style value...) . rest)
      (list
         " style=\""value..."\""
         (a - . rest)))

   ((a - . rest)
      (list ">" . rest))
   ((a . rest)
      (list
         "<a"
            (a - . rest)
         "</a>"))))

(define-syntax ul
(syntax-rules ()
   ((ul rest...)
      (list
         "<ul>"
           rest...
         "</ul>"))))

(define-syntax br
(syntax-rules ()
   ((br)
      "<br>")))
(define-syntax hr
(syntax-rules ()
   ((hr)
      "<hr>")))

(define-syntax li
(syntax-rules (- style)
   ((li - (style value) rest...)
      (list
         " style=\""value"\""
         (li - rest...)))

   ((li - rest...)
      (list ">" rest...))
   ((li rest...)
      (list
         "<li"
           (li - rest...)
         "</li>"))))
(define-syntax li-
   (syntax-rules ()
      ((li- rest...)
         (list
            "<li style='clear:both'>"
              rest...
            "</li>"))))



(define-syntax label
(syntax-rules ()
   ((label rest...)
      (list
         "<label>"
            rest...
         "</label>"))))

(define-syntax input
(syntax-rules (- id type name placeholder required readonly value)
   ((input - (id arg) rest...)
      (list
         " id=\""arg"\""
         (input - rest...)))
   ((input - (type arg) rest...)
      (list
         " type=\""arg"\""
         (input - rest...)))
   ((input - (name arg) rest...)
      (list
         " name=\""arg"\""
         (input - rest...)))
   ((input - (placeholder arg) rest...)
      (list
         " placeholder=\""arg"\""
         (input - rest...)))
   ((input - (required) rest...)
      (list
         " required"
         (input - rest...)))
;   ((input - (readonly is) rest...)
;      (list
;         (if is " readonly")
;         (input - rest...)))
   ((input - (readonly) rest...)
      (list
         " readonly"
         (input - rest...)))
   ((input - (value arg) rest...)
      (list
         " value=\""arg"\""
         (input - rest...)))

   ((input - rest...)
      (list ">" rest...))
   ((input rest...)
      (list
         "<input"
           (input - rest...)))))

(define-syntax table
(syntax-rules ()
   ((table rest...)
      (list
         "<table>"
           rest...
         "</table>"))))
(define-syntax tr
(syntax-rules ()
   ((tr rest...)
      (list
         "<tr>"
           rest...
         "</tr>"))))
(define-syntax th
(syntax-rules ()
   ((th rest...)
      (list
         "<th>"
           rest...
         "</th>"))))
(define-syntax td
(syntax-rules (- colspan style)
   ((td - (style value) rest...)
      (list
         " style="value
         (td - rest...)))
   ((td - (colspan value) rest...)
      (list
         " colspan="value
         (td - rest...)))

   ((td - rest...)
      (list ">" rest...))
   ((td rest...)
      (list
         "<td"
           (td - rest...)
         "</td>"))))


(define (map* f a)
   (let loop ((a a))
      (if (null? a)
         '()
         (cons (apply f (car a)) (loop (cdr a))))))


(define (clear name)
   (html (script "$('#"name"').remove()")))

; =-( main )=-------------------------------
; this will be the first content data staff
; load main javascript with all weird staff:
(print)
   (html (script "$('#loading').remove()"))

(define (assign-session content)
   (fork-server 'sess (lambda ()
   (let this ((session content))
   (let* ((envelope (wait-mail))
          (sender msg envelope))
      (mail sender session))))))
;(fork-server 'session (lambda ()
;(let this ((session value))
;(let* ((envelope (wait-mail))
;       (sender msg envelope))
;   (tuple-case msg
;      ((set new)
;         (this new))
;      ((get)
;         (mail sender session)
;         (this session)))))))

(define (show-login-section)
   (html
      (section (id "main")
               (class "loginform cf")
         ; http://www.scriptol.com/html5/forms.php
         (form (id "login")
               (action "/login")
            (ul
               (li (label "Email")
                   (input (id "usermail") (type "usermail")
                          (placeholder "yourname@mail.com")
                          (required)))
               (li (label "Password")
                   (input (id "password") (type "password")
                          (placeholder "strong passphrase")
                          (required)))
               (li-
                   (input (type "submit") (value "Login")))))
         (script
               "$('#login').submit(function(event) {
               goto([login.action,
                     login.elements.usermail.value,
                     login.elements.password.value]
                     ,'login-ok', '-fail-');
               event.preventDefault();
            });")))
   (print))

; если логин прошел нормально, покажем домашний скрин
(define (login-ok session)
   (assign-session session)
   (html (script "console.log('login-ok/ session: "session"')"))
   (html (script "
            goto(['/home', '"session"']
                  ,'home', '-fail-');"))
   (print))

(define (home username data)
   (define session (interact 'sess #f))
   (html (script "console.log('home/ data: "data"')"))
   (clear "main")
   (html "<div id='main'>"
         "<br>"
         "Hello " username
         "<br><hr><br>"

   ; в эту табличку мы поместим все расы игрока и играемые ними игры:
         (table
               (tr (th "Race") (th "Game"))
               (map* (lambda (rid name games)
                  (tr
                     (td
                        (a (href "/race/"session"/"rid) name))
                     (td
                        (table
                           (map* (lambda (gid name state)
                                       (tr
                                          (td gid) (td name)
                                          (td (a (href "/game/"session"/"gid)
                                                (if (eq? state 0)
                                                   "(edit)"
                                                   "(view)")))
                                          (td
                                             (case state ; todo: make new query to check the current race state, not common
                                                (0 "New one")
                                                (1 "Waiting for players")
                                                (2 "Wait for turns")
                                                (3 "Thinking...")
                                                (4 "Closed")
                                                (else "Unknown")))))
                              games)
                           (tr
                              (td (colspan 4) (style "text-align:center")
                                 (a (href "/create-new-game/"session"/"rid) "(create new game)")))
                     ))
                  ))
                  data)
               (tr (td (colspan 2) (style "text-align:center")
                  (a (href "/create-new-race/"session) "(create new race)"))))

         "</div>")
   (print))

;                     (db:map (db:query
;                        "SELECT  id,name  FROM races WHERE account=?" account)
;                        (lambda (id name) (tr
;                           (td
;                              (a (href "/race/"session"/"id) name))
;                           (td
;                              (table
;                                 (db:map (db:query
;                                    "SELECT  id,name,state  FROM games WHERE id IN (
;                                       SELECT DISTINCT game FROM game_players WHERE race=?
;                                     )" id)
;                                    (lambda (id name state)
;                                       (tr
;                                          (td id) (td name)
;                                          (td (a (href "/game/"session"/"id)
;                                                (if (eq? state 0)
;                                                   "(edit)"
;                                                   "(view)")))
;                                          (td
;                                             (case state ; todo: make new query to check the current race state, not common
;                                                (0 "New one")
;                                                (1 "Waiting for players")
;                                                (2 "Wait for turns")
;                                                (3 "Thinking...")
;                                                (4 "Closed")
;                                                (else "Unknown"))))))
;                                 (tr
;                                    (td (colspan 4) (style "text-align:center")
;                                       (a (href "/create-new-game/"session"/"id) "(create new game)")))
;                                 )))))
;                     (tr (td (colspan 2) (style "text-align:center")
;                        (a (href "/create-new-race/"session) "(create new race)")))
;                  )))










; let's game begin
(show-login-section) ; temp skip the login screen
;(login-ok "cb4673f67fee197cab1f30ab52cbbf66")

(define (-fail- answer)
   (print "<br>fail: " answer))

;(define (login-ok session)
;   ; login ok, let's get values to home screen
;         ; request new home
;   (html (script "
;            goto(['/home/', "session"],
;                  ,'home', '-fail-');
;         "))


; ===============================================================
; домашний экран пользователя
;(define (home session)
;   (html (script "$('#main').remove()"))
;
;
;      (
;
;
;)



;                        ; ok
;                        (script "goto('/home/"session"')")
;                        ; error
;                        (section (class "loginform cf")
;                           (form (id "sorry")
;                                 (action "/")
;                                 (onsubmit "window.location = '/'; return false")
;                              (ul
;                                 (li (label "Sorry, name or password is invalid."))
;                                 (li (a (href "/") "Please, try again") "."))))))))


(print) ;flush (на всякий случай)
</script></body></html>